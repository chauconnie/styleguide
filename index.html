<script>
  const chat = document.getElementById('chat');
  const input = document.getElementById('userInput');
  const tagsContainer = document.getElementById('tagsContainer');

  // Example keyword tags
  const keywordTags = [
    "Capitalization","Contractions","Numbers","Punctuation","Oxford comma","Plurals","Text formatting","Tone","Voice","Buttons","Error messages","Confirmation or success messages","Help or instructional text","Placeholder text","Tooltips","Link text","Proper nouns","IDs","Dates","Titles and Headers","Labels","Lists","Tables"
  ];

  // Render tags on initial load
  keywordTags.forEach(tag => {
    const el = document.createElement('div');
    el.className = 'tag';
    el.textContent = tag;
    el.onclick = () => {
      appendMessage(tag, 'user');
      sendQuery(tag);
    };
    tagsContainer.appendChild(el);
  });

  function appendMessage(text, sender) {
    const msg = document.createElement('div');
    msg.className = 'message ' + sender;

    if (sender === 'bot') {
      msg.innerHTML = marked.parse(text); // Render markdown for bot messages
    } else {
      msg.textContent = text;
    }

    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
    return msg;
  }

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    appendMessage(text, 'user');
    input.value = '';
    sendQuery(text);
  }

  async function sendQuery(query) {
    // Add a loading message with simple animated dots
    const loadingMsg = appendMessage('‚è≥ Thinking...', 'bot');
    loadingMsg.classList.add('loading');

    try {
      const res = await fetch('https://corsproxy.io/?https://n8n-webhook.dev.firsthand.ai/webhook/search-guides', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: query })
      });

      if (!res.ok) throw new Error('Server error');
      
      const data = await res.json();
      loadingMsg.remove(); // Remove loading message
      appendMessage(data.answer || 'No answer found.', 'bot');
    } catch (err) {
      loadingMsg.remove(); // Remove loading message
      appendMessage('Error reaching the server.', 'bot');
    }
  }

  input.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') sendMessage();
  });
</script>
